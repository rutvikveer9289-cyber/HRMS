<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@500&display=swap" rel="stylesheet">
<div class="app-layout-wrapper" *ngIf="authService.isLoggedIn() && router.url !== '/login' && router.url !== '/signup'">
  <!-- Top Header -->
  <header class="app-header">
    <div class="header-left">
      <!-- Menu Toggle Button -->
      <button class="menu-toggle-btn" (click)="toggleSidebar()" [class.active]="sidebarOpen">
        <i data-lucide="menu"></i>
      </button>

      <!-- Logo -->
      <div class="brand-wrapper" routerLink="/dashboard" (click)="resetMenus()" style="cursor: pointer">
        <img src="https://huntscaler.blob.core.windows.net/rbisimages/rbis logo .svg" alt="RBIS Logo" class="logo-img">
      </div>
    </div>

    <div class="header-right">
      <!-- Action Center (Notifications) -->
      <div class="header-action-item notification-trigger" *ngIf="router.url !== '/login' && router.url !== '/signup'"
        (click)="toggleNotificationMenu()" [class.active]="notificationMenuOpen">
        <i data-lucide="bell"></i>
        <span class="notification-badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>

        <div class="notification-dropdown" *ngIf="notificationMenuOpen" (click)="$event.stopPropagation()">
          <div class="dropdown-header">
            <h3>Notifications</h3>
            <div class="header-actions">
              <button class="btn-text" (click)="markAllAsRead()" *ngIf="unreadCount > 0">Mark read</button>
              <button class="btn-text secondary" (click)="clearAllNotifications()"
                *ngIf="notifications.length > 0">Clear Center</button>
            </div>
          </div>
          <div class="notification-list">
            <div class="notification-item" *ngFor="let n of notifications" [class.unread]="!n.is_read"
              (click)="markAsRead(n)">
              <div class="n-icon" [class]="n.type.toLowerCase()">
                <i *ngIf="n.type === 'LEAVE'" data-lucide="calendar"></i>
                <i *ngIf="n.type === 'ANNOUNCEMENT'" data-lucide="megaphone"></i>
                <i *ngIf="n.type === 'SYSTEM'" data-lucide="info"></i>
              </div>
              <div class="n-content">
                <p class="n-msg">{{ n.message }}</p>
                <span class="n-time">{{ n.created_at | date:'shortTime' }}</span>
              </div>
              <div class="n-actions">
                <div class="n-unread-dot" *ngIf="!n.is_read"></div>
                <button class="n-delete-btn" (click)="deleteNotification($event, n)" title="Dismiss">
                  <i data-lucide="x"></i>
                </button>
              </div>
            </div>
            <div class="empty-notifications" *ngIf="notifications.length === 0">
              <i data-lucide="bell-off"></i>
              <p>No notifications yet</p>
            </div>
          </div>
        </div>
      </div>

      <!-- User Profile Display -->
      <div class="header-profile-section" routerLink="/profile" (click)="resetMenus()"
        *ngIf="router.url !== '/login' && router.url !== '/signup'" style="cursor: pointer">
        <span class="u-name-header">{{ getUserDisplayName(currentUser) }}</span>
      </div>
    </div>
  </header>

  <!-- Main Layout with Sidebar -->
  <div class="app-main-layout">
    <!-- Sidebar Overlay (for mobile/closing) -->
    <div class="sidebar-overlay" *ngIf="sidebarOpen" (click)="toggleSidebar()"></div>

    <!-- Left Sidebar Navigation -->
    <aside class="sidebar-nav" [class.open]="sidebarOpen">
      <!-- User Profile Card in Sidebar -->
      <div class="sidebar-profile-card">
        <div class="sidebar-avatar">
          {{ getInitials(currentUser) }}
        </div>
        <div class="sidebar-user-info">
          <div class="sidebar-username">{{ getUserDisplayName(currentUser) }}</div>
          <div class="sidebar-role">{{ currentUser?.role }}</div>
        </div>
      </div>

      <!-- Navigation Items -->
      <nav class="sidebar-menu">
        <a routerLink="/profile" routerLinkActive="active" class="sidebar-item profile-item"
          (click)="sidebarOpen = false" title="My Profile">
          <i data-lucide="user"></i>
          <span>My Profile</span>
        </a>

        <a routerLink="/analytics" routerLinkActive="active" class="sidebar-item" (click)="sidebarOpen = false"
          title="Analytics">
          <i data-lucide="bar-chart-2"></i>
          <span>Analytics</span>
        </a>
        <a *ngIf="isHr" routerLink="/employee-management" routerLinkActive="active" class="sidebar-item"
          (click)="sidebarOpen = false" title="Employees">
          <i data-lucide="users"></i>
          <span>Employees</span>
        </a>
        <a *ngIf="isAdmin" routerLink="/attendance-operations" routerLinkActive="active" class="sidebar-item"
          (click)="sidebarOpen = false" title="Operations">
          <i data-lucide="settings"></i>
          <span>Operations</span>
        </a>
        <a *ngIf="isHr" routerLink="/onboarding" routerLinkActive="active" class="sidebar-item"
          (click)="sidebarOpen = false" title="Onboarding">
          <i data-lucide="user-plus"></i>
          <span>Onboarding</span>
        </a>
        <a routerLink="/leave-management" routerLinkActive="active" class="sidebar-item" (click)="sidebarOpen = false"
          title="Leaves">
          <i data-lucide="calendar"></i>
          <span>Leaves</span>
        </a>
        <a routerLink="/payroll-management" routerLinkActive="active" class="sidebar-item" (click)="sidebarOpen = false"
          title="Payroll">
          <i data-lucide="credit-card"></i>
          <span>Payroll</span>
        </a>
        <a *ngIf="isHr || isCeo" routerLink="/records" routerLinkActive="active" class="sidebar-item"
          (click)="sidebarOpen = false" title="Records">
          <i data-lucide="clipboard-list"></i>
          <span>Records</span>
        </a>

        <button class="sidebar-item logout-item" (click)="logout()" title="Logout">
          <i data-lucide="log-out"></i>
          <span>Logout</span>
        </button>
      </nav>
    </aside>

    <!-- Main Content Area -->
    <main class="page-content-container">
      <router-outlet></router-outlet>
    </main>
  </div>
</div>

<!-- Auth Pages View (Standalone) -->
<div *ngIf="!authService.isLoggedIn() || router.url === '/login' || router.url === '/signup'">
  <router-outlet></router-outlet>
</div>

<!-- Global Notifications -->
<div class="alerts-container">
  <div *ngFor="let alert of alerts" class="alert-toast" [class]="alert.type">
    <div class="alert-icon" *ngIf="router.url !== '/login' && router.url !== '/signup'">
      <i *ngIf="alert.type === 'success'" data-lucide="check-circle"></i>
      <i *ngIf="alert.type === 'error'" data-lucide="alert-circle"></i>
      <i *ngIf="alert.type === 'info'" data-lucide="info"></i>
    </div>
    <span class="alert-msg">{{ alert.message }}</span>
    <button class="alert-close" (click)="removeAlert(alert.id)">&times;</button>
  </div>
</div>